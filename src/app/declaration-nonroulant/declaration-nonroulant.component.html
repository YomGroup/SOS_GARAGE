<!-- Composant: declaration-vehicule-non-roulant.component.html -->
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-warning text-white text-center py-4">
          <h2 class="mb-0">
            <i class="fas fa-car-crash me-2"></i>
            Déclaration de Sinistre - Véhicule Non Roulant
          </h2>
          <p class="mb-0 mt-2 opacity-75">Situation d'urgence - Prise en charge immédiate</p>
        </div>
        
        <div class="card-body p-4">
          <!-- Alert urgence -->
          <div class="alert alert-warning border-warning mb-4" *ngIf="isUrgentSituation">
            <div class="d-flex align-items-center">
              <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
              <div>
                <h5 class="alert-heading mb-1">Situation d'urgence détectée</h5>
                <p class="mb-0">Un professionnel vous contactera dans les <strong>5 minutes</strong> suivant votre déclaration.</p>
              </div>
            </div>
          </div>

          <!-- Étape 1: Sécurité et urgence -->
          <div class="step-section mb-4" *ngIf="currentStep === 1">
            <div class="step-header mb-4">
              <h4 class="text-primary fw-bold">
                <span class="badge bg-danger rounded-circle me-2">1</span>
                Sécurité et situation d'urgence
              </h4>
            </div>
            
            <form [formGroup]="step1Form">
              <div class="row g-3">
                <div class="col-12">
                  <div class="card border-danger">
                    <div class="card-body">
                      <h5 class="text-danger mb-3">
                        <i class="fas fa-shield-alt me-2"></i>Êtes-vous en sécurité ?
                      </h5>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="isSafe" id="secure" [value]="true">
                            <label class="form-check-label fw-semibold text-success" for="secure">
                              <i class="fas fa-check-circle me-1"></i>Oui, je suis en sécurité
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="isSafe" id="notSecure" [value]="false">
                            <label class="form-check-label fw-semibold text-danger" for="notSecure">
                              <i class="fas fa-exclamation-triangle me-1"></i>Non, situation dangereuse
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-12">
                  <div class="card border-warning">
                    <div class="card-body">
                      <h5 class="text-warning mb-3">
                        <i class="fas fa-ambulance me-2"></i>Y a-t-il des blessés ?
                      </h5>
                      <div class="row g-2">
                        <div class="col-md-4">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="injuryLevel" id="noInjuries" value="none">
                            <label class="form-check-label fw-semibold" for="noInjuries">
                              <i class="fas fa-user-check me-1 text-success"></i>Aucun blessé
                            </label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="injuryLevel" id="lightInjuries" value="light">
                            <label class="form-check-label fw-semibold" for="lightInjuries">
                              <i class="fas fa-band-aid me-1 text-warning"></i>Blessures légères
                            </label>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="injuryLevel" id="seriousInjuries" value="serious">
                            <label class="form-check-label fw-semibold" for="seriousInjuries">
                              <i class="fas fa-procedures me-1 text-danger"></i>Blessures graves
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Date et heure de l'accident *</label>
                  <input type="datetime-local" class="form-control form-control-lg" formControlName="accidentDate" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Votre position actuelle *</label>
                  <div class="input-group">
                    <input type="text" class="form-control form-control-lg" formControlName="currentLocation" placeholder="Adresse exacte..." required>
                    <button class="btn btn-outline-primary" type="button" (click)="useGeolocation()">
                      <i class="fas fa-map-marker-alt"></i>
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Étape 2: Détails de l'accident -->
          <div class="step-section mb-4" *ngIf="currentStep === 2">
            <div class="step-header mb-4">
              <h4 class="text-primary fw-bold">
                <span class="badge bg-primary rounded-circle me-2">2</span>
                Détails de l'accident
              </h4>
            </div>
            
            <form [formGroup]="step2Form">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label fw-semibold">Sélectionnez votre véhicule *</label>
                  <select class="form-select form-select-lg" formControlName="selectedVehicleId" required>
                    <option value="">Choisir un véhicule...</option>
                    <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">{{vehicle.displayName}}</option>
                  </select>
                </div>
                
                <div class="col-12">
                  <label class="form-label fw-semibold">Pourquoi le véhicule n'est-il plus roulant ? *</label>
                  <div class="row g-2">
                    <div class="col-md-6" *ngFor="let reason of ['Dommages mécaniques', 'Carrosserie endommagée', 'Roues/pneus endommagés', 'Autres dommages']">
                      <div class="form-check form-check-lg">
                        <input class="form-check-input" type="checkbox" 
                               [id]="'reason-'+reason" 
                               (change)="onNonRollingReasonChange(reason, $event)">
                        <label class="form-check-label" [for]="'reason-'+reason">
                          <i class="fas fa-cog me-1" *ngIf="reason === 'Dommages mécaniques'"></i>
                          <i class="fas fa-car-side me-1" *ngIf="reason === 'Carrosserie endommagée'"></i>
                          <i class="fas fa-tire me-1" *ngIf="reason === 'Roues/pneus endommagés'"></i>
                          <i class="fas fa-exclamation me-1" *ngIf="reason === 'Autres dommages'"></i>
                          {{reason}}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-12">
                  <label class="form-label fw-semibold">Description détaillée de l'accident *</label>
                  <textarea class="form-control" rows="4" formControlName="accidentDescription" 
                            placeholder="Décrivez précisément ce qui s'est passé, les circonstances, les dégâts observés..." required></textarea>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Forces de l'ordre sur place ?</label>
                  <select class="form-select form-select-lg" formControlName="policePresence">
                    <option value="">Sélectionnez...</option>
                    <option value="non">Non</option>
                    <option value="police">Police</option>
                    <option value="gendarmerie">Gendarmerie</option>
                    <option value="pompiers">Pompiers</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Autres véhicules impliqués ?</label>
                  <select class="form-select form-select-lg" formControlName="otherVehiclesInvolved">
                    <option value="">Sélectionnez...</option>
                    <option value="non">Non</option>
                    <option value="1">1 autre véhicule</option>
                    <option value="2+">2 véhicules ou plus</option>
                  </select>
                </div>
              </div>
            </form>
          </div>

          <!-- Étape 3: Remorquage et assistance -->
          <div class="step-section mb-4" *ngIf="currentStep === 3">
            <div class="step-header mb-4">
              <h4 class="text-primary fw-bold">
                <span class="badge bg-primary rounded-circle me-2">3</span>
                Remorquage et assistance immédiate
              </h4>
            </div>
            
            <form [formGroup]="step3Form">
              <div class="row g-4">
                <div class="col-12">
                  <div class="card border-primary">
                    <div class="card-body">
                      <h5 class="text-primary mb-3">
                        <i class="fas fa-truck me-2"></i>Besoin de remorquage ?
                      </h5>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="needsTowing" id="needTowing" [value]="true">
                            <label class="form-check-label fw-semibold" for="needTowing">
                              <i class="fas fa-check-circle me-1 text-success"></i>Oui, remorquage nécessaire
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-check form-check-lg">
                            <input class="form-check-input" type="radio" formControlName="needsTowing" id="noTowing" [value]="false">
                            <label class="form-check-label fw-semibold" for="noTowing">
                              <i class="fas fa-times-circle me-1 text-danger"></i>Non, déjà pris en charge
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6" *ngIf="step3Form.get('needsTowing')?.value">
                  <label class="form-label fw-semibold">Destination souhaitée</label>
                  <select class="form-select form-select-lg" formControlName="towingDestination">
                    <option value="">Sélectionnez...</option>
                    <option value="garage">Garage de réparation</option>
                    <option value="domicile">Domicile</option>
                    <option value="expert">Expertise assurance</option>
                    <option value="autre">Autre lieu</option>
                  </select>
                </div>
                
                <div class="col-md-6" *ngIf="step3Form.get('needsTowing')?.value">
                  <label class="form-label fw-semibold">Adresse de destination</label>
                  <input type="text" class="form-control form-control-lg" formControlName="destinationAddress" placeholder="Adresse complète...">
                </div>
                
                <div class="col-12">
                  <div class="alert alert-info">
                    <h6 class="alert-heading">
                      <i class="fas fa-info-circle me-2"></i>Services d'assistance disponibles
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                          <li><i class="fas fa-check text-success me-2"></i>Remorquage d'urgence</li>
                          <li><i class="fas fa-check text-success me-2"></i>Véhicule de remplacement</li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                          <li><i class="fas fa-check text-success me-2"></i>Rapatriement passagers</li>
                          <li><i class="fas fa-check text-success me-2"></i>Hébergement si nécessaire</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Étape 4: Photos et finalisation -->
          <div class="step-section mb-4" *ngIf="currentStep === 4">
            <div class="step-header mb-4">
              <h4 class="text-primary fw-bold">
                <span class="badge bg-primary rounded-circle me-2">4</span>
                Photos et finalisation urgente
              </h4>
            </div>
            
            <form [formGroup]="step4Form">
              <div class="row g-4">
                <div class="col-12">
                  <div class="alert alert-warning">
                    <i class="fas fa-camera me-2"></i>
                    <strong>Photos prioritaires :</strong> Concentrez-vous sur les dégâts les plus importants. Vous pourrez ajouter d'autres photos plus tard.
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="upload-zone border border-2 border-dashed border-danger rounded-3 p-4 text-center">
                    <i class="fas fa-camera fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">Photos des dégâts principaux</h5>
                    <p class="text-muted">Vue d'ensemble du véhicule</p>
                    <input type="file" class="form-control" multiple accept="image/*" (change)="onUrgentPhotosSelected($event)">
                    <small class="text-muted">Minimum 2 photos requises</small>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="upload-zone border border-2 border-dashed border-warning rounded-3 p-4 text-center">
                    <i class="fas fa-file-contract fa-3x text-warning mb-3"></i>
                    <h5 class="text-warning">Documents disponibles</h5>
                    <p class="text-muted">Constat, PV, ordonnance...</p>
                    <input type="file" class="form-control" multiple accept="image/*,.pdf" (change)="onDocumentsSelected($event)">
                    <small class="text-muted">Formats: JPG, PNG, PDF</small>
                  </div>
                </div>
              </div>
              
              <div class="card bg-light mt-4">
                <div class="card-body">
                  <h5 class="card-title text-primary">Récapitulatif - Intervention d'urgence</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <ul class="list-unstyled">
                        <li><strong>Statut:</strong> <span class="badge bg-danger">Véhicule non roulant</span></li>
                        <li><strong>Sécurité:</strong> {{ step1Form.get('isSafe')?.value ? 'Confirmée' : 'À risque' }}</li>
                        <li><strong>Position:</strong> {{ step1Form.get('currentLocation')?.value || 'Non renseigné' }}</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <ul class="list-unstyled">
                        <li><strong>Blessés:</strong> 
                          {{ step1Form.get('injuryLevel')?.value === 'none' ? 'Aucun' : 
                             step1Form.get('injuryLevel')?.value === 'light' ? 'Légères' : 'Graves' }}
                        </li>
                        <li><strong>Remorquage:</strong> {{ step3Form.get('needsTowing')?.value ? 'Requis' : 'Non nécessaire' }}</li>
                        <li><strong>Forces de l'ordre:</strong> {{ step2Form.get('policePresence')?.value || 'Non renseigné' }}</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="form-check mt-4">
                <input class="form-check-input form-check-input-lg" type="checkbox" id="urgentConfirm" formControlName="isUrgentConfirmed">
                <label class="form-check-label fw-semibold" for="urgentConfirm">
                  Je confirme la situation d'urgence et demande une prise en charge immédiate
                </label>
              </div>
            </form>
          </div>

          <!-- Navigation -->
          <div class="d-flex justify-content-between align-items-center mt-5">
            <button class="btn btn-outline-secondary btn-lg" 
                    *ngIf="currentStep > 1" 
                    (click)="previousStep()">
              <i class="fas fa-chevron-left me-2"></i>Précédent
            </button>
            
            <div class="step-indicator mx-auto">
              <span class="badge" 
                    [class]="currentStep >= 1 ? (currentStep === 1 ? 'bg-danger' : 'bg-success') : 'bg-secondary'">1</span>
              <span class="step-line" 
                    [class]="currentStep >= 2 ? 'active' : ''"></span>
              <span class="badge" 
                    [class]="currentStep >= 2 ? 'bg-primary' : 'bg-secondary'">2</span>
              <span class="step-line" 
                    [class]="currentStep >= 3 ? 'active' : ''"></span>
              <span class="badge" 
                    [class]="currentStep >= 3 ? 'bg-primary' : 'bg-secondary'">3</span>
              <span class="step-line" 
                    [class]="currentStep >= 4 ? 'active' : ''"></span>
              <span class="badge" 
                    [class]="currentStep >= 4 ? 'bg-primary' : 'bg-secondary'">4</span>
            </div>
            
            <button class="btn btn-primary btn-lg" 
                    *ngIf="currentStep < 4" 
                    (click)="nextStep()"
                    [disabled]="!isStepValid(currentStep)">
              Suivant<i class="fas fa-chevron-right ms-2"></i>
            </button>
            
            <button class="btn btn-danger btn-lg pulse-animation" 
                    *ngIf="currentStep === 4" 
                    (click)="submitUrgentDeclaration()"
                    [disabled]="!step4Form.valid || isSubmitting">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ isSubmitting ? 'Envoi en cours...' : 'DÉCLARATION URGENTE' }}
            </button>
          </div>
        </div>
      </div>
      
      <!-- Assistance d'urgence -->
      <div class="card mt-4 border-danger">
        <div class="card-body bg-danger text-white">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-1">
                <i class="fas fa-phone-alt me-2"></i>Assistance d'urgence 24h/24
              </h5>
              <p class="mb-0">En cas de danger immédiat, contactez-nous directement</p>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-light btn-lg fw-bold" (click)="callEmergencySupport()">
                <i class="fas fa-phone me-2"></i>0800 123 456
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Statut de prise en charge -->
      <div class="card mt-4" *ngIf="declarationSubmitted">
        <div class="card-body text-center">
          <div class="spinner-border text-warning mb-3" role="status" *ngIf="!emergencyResponse">
            <span class="visually-hidden">Traitement en cours...</span>
          </div>
          <div *ngIf="emergencyResponse">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">Déclaration envoyée avec succès</h5>
          </div>
          <h5 class="text-warning">{{ emergencyResponse ? 'Prise en charge confirmée' : 'Prise en charge en cours...' }}</h5>
          <p class="text-muted">{{ emergencyResponse ? emergencyResponse.message : 'Un professionnel vous contacte dans les 5 minutes' }}</p>
          <div class="progress mt-3" *ngIf="!emergencyResponse">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                 role="progressbar" style="width: 75%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>