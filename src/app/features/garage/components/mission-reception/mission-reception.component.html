<!-- Réception de Mission - Design moderne et responsive -->
<div class="mission-reception-container">
  <!-- Header moderne avec gradient et effets visuels -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-3 header-section">
    <h2 class="mission-title mb-0">
      <i class="fas fa-clipboard-list me-2"></i>Réception des missions
    </h2>
    <span class="badge bg-primary fs-6 shadow-sm">
      <i class="fas fa-tasks me-1"></i>{{ missions.length }} missions
    </span>
  </div>

  <!-- État de chargement amélioré -->
  <div *ngIf="loading" class="loading-state">
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-3 text-muted fs-5">Chargement des missions en cours...</p>
      <div class="progress mt-3" style="width: 200px; margin: 0 auto;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 100%"></div>
      </div>
    </div>
  </div>

  <!-- État d'erreur avec retry -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="alert alert-danger text-center border-0 shadow-sm">
      <i class="fas fa-exclamation-triangle me-2 fs-4"></i>
      <div class="mt-2">
        <strong>{{ error }}</strong>
      </div>
      <button class="btn btn-outline-danger btn-sm ms-3 mt-2" (click)="loadMissions()">
        <i class="fas fa-redo me-1"></i>Réessayer
      </button>
    </div>
  </div>

  <!-- Message si aucune mission en attente -->
  <div *ngIf="!loading && !error && missions.length === 0" class="no-mission-state">
    <div class="text-center py-5">
      <div class="no-mission-icon">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <h4 class="text-muted mt-3 mb-2">Aucune mission en attente</h4>
      <p class="text-muted mb-1">Vous n'avez actuellement aucune mission à traiter.</p>
      <p class="text-muted small opacity-75">Les nouvelles missions apparaîtront ici automatiquement.</p>
      <div class="mt-4">
        <button class="btn btn-outline-primary btn-sm" (click)="loadMissions()">
          <i class="fas fa-sync-alt me-1"></i>Actualiser
        </button>
      </div>
    </div>
  </div>

  <!-- Grille responsive des missions avec animations -->
  <div *ngIf="!loading && !error && missions.length > 0" class="row g-4 px-4">
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3" *ngFor="let mission of missions; trackBy: trackByMissionId">
      <div class="document-card h-100 d-flex flex-column justify-content-between hover-effect" 
           tabindex="0" 
           (keydown.enter)="ouvrirDetails(mission)"
           (keydown.space)="ouvrirDetails(mission)">
        <div class="d-flex align-items-start mb-3">
          <div class="document-icon reports me-3 shadow-sm">
            <i class="fas fa-clipboard-check"></i>
          </div>
          <div class="mission-info flex-grow-1">
            <h5 class="mb-2 text-truncate fw-bold">Mission #{{ mission.id }}</h5>
            <div class="text-muted small mb-1">
              <i class="fas fa-user me-1"></i>{{ mission.sinistre?.type || 'N/A' }}
            </div>
            <div class="text-muted small mb-1">
              <i class="fas fa-car me-1"></i>{{ mission.sinistre?.contactAssistance || 'N/A' }}
            </div>
            <div class="text-muted small mb-2">
              <i class="far fa-calendar-alt me-1"></i>{{ getMissionDate(mission) }}
            </div>
            <div class="status-badge" [ngClass]="'status-' + mission.statut.toLowerCase()">
              <i class="fas fa-circle me-1" style="font-size: 0.6rem;"></i>{{ mission.statut }}
            </div>
          </div>
        </div>
        <div class="mt-auto text-end">
          <button class="btn btn-outline-primary btn-sm px-4 rounded-pill action-btn" 
                  (click)="ouvrirDetails(mission)"
                  [attr.aria-label]="'Voir les détails de la mission ' + mission.id">
            <i class="fas fa-eye me-1"></i> Voir détails
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau latéral de détails modernisé -->
  <div class="side-panel" [class.open]="panelOuvert" role="dialog" aria-modal="true" aria-labelledby="panel-title">
    <div class="side-panel-content" *ngIf="missionSelectionnee">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 panel-title" id="panel-title">
          <i class="fas fa-info-circle me-2"></i>Détails de la mission
        </h4>
        <button class="close-btn" (click)="fermerPanel()" aria-label="Fermer le panneau">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Détails du sinistre -->
      <div *ngIf="missionSelectionnee.sinistre; else noSinistre" class="mb-4">
        <h5 class="section-subtitle">
          <i class="fas fa-exclamation-triangle me-2"></i>Informations du sinistre
        </h5>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-user me-2"></i>Type de sinistre
          </div>
          <div class="detail-value">{{ missionSelectionnee.sinistre.type }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-car me-2"></i>Contact assistance
          </div>
          <div class="detail-value">{{ missionSelectionnee.sinistre.contactAssistance }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-file-alt me-2"></i>Lien constat
          </div>
          <div class="detail-value">
            <a *ngIf="missionSelectionnee.sinistre.lienConstat" 
               [href]="missionSelectionnee.sinistre.lienConstat" 
               target="_blank" 
               class="text-decoration-none">
              <i class="fas fa-external-link-alt me-1"></i>Voir le constat
            </a>
            <span *ngIf="!missionSelectionnee.sinistre.lienConstat" class="text-muted">Non renseigné</span>
          </div>
        </div>
      </div>
      <ng-template #noSinistre>
        <div class="alert alert-warning border-0 shadow-sm">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Aucun sinistre associé à cette mission.
        </div>
      </ng-template>

      <!-- Détails mission -->
      <div class="mb-4">
        <h5 class="section-subtitle">
          <i class="fas fa-clipboard-list me-2"></i>Détails de la mission
        </h5>
        <div class="detail-item">
          <div class="detail-label">
            <i class="far fa-calendar-alt me-2"></i>Date de création
          </div>
          <div class="detail-value">{{ getMissionDate(missionSelectionnee) }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-euro-sign me-2"></i>Devis
          </div>
          <div class="detail-value">
            <span class="fw-bold text-success">{{ missionSelectionnee.devis | number:'1.0-0' }} €</span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-file-invoice-dollar me-2"></i>Facture finale
          </div>
          <div class="detail-value">
            <span class="fw-bold text-primary">{{ missionSelectionnee.factureFinale | number:'1.0-0' }} €</span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-car-side me-2"></i>Prêt de véhicule
          </div>
          <div class="detail-value">
            <span [class]="missionSelectionnee.pretVehicule ? 'text-success' : 'text-muted'">
              <i [class]="missionSelectionnee.pretVehicule ? 'fas fa-check' : 'fas fa-times'" class="me-1"></i>
              {{ missionSelectionnee.pretVehicule ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-exclamation-triangle me-2"></i>Déclarée comme épave
          </div>
          <div class="detail-value">
            <span [class]="missionSelectionnee.declareCommeEpave ? 'text-warning' : 'text-muted'">
              <i [class]="missionSelectionnee.declareCommeEpave ? 'fas fa-check' : 'fas fa-times'" class="me-1"></i>
              {{ missionSelectionnee.declareCommeEpave ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="fas fa-check-double me-2"></i>Épave validée par admin
          </div>
          <div class="detail-value">
            <span [class]="missionSelectionnee.epaveValideeParAdmin ? 'text-success' : 'text-muted'">
              <i [class]="missionSelectionnee.epaveValideeParAdmin ? 'fas fa-check' : 'fas fa-times'" class="me-1"></i>
              {{ missionSelectionnee.epaveValideeParAdmin ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <i class="far fa-calendar-check me-2"></i>Date déclaration épave
          </div>
          <div class="detail-value">
            {{ missionSelectionnee.dateDeclarationEpave || 'Non renseignée' }}
          </div>
        </div>
      </div>

      <!-- Photos véhicule -->
      <div class="photos-section mb-4">
        <h5 class="section-subtitle">
          <i class="fas fa-camera me-2"></i>Photos du véhicule
        </h5>
        <div *ngIf="isPhotosArrayNonEmpty(missionSelectionnee); else noPhotos" class="photos-grid">
          <div class="photo-thumbnail" 
               *ngFor="let photo of missionSelectionnee.photosVehicule; let i = index"
               (click)="openPhotoViewer(photo, i)"
               tabindex="0"
               (keydown.enter)="openPhotoViewer(photo, i)"
               (keydown.space)="openPhotoViewer(photo, i)"
               [attr.aria-label]="'Photo ' + (i + 1) + ' du véhicule'">
            <img [src]="photo" alt="Photo véhicule" class="img-fluid" loading="lazy" />
            <div class="photo-overlay">
              <i class="fas fa-search-plus"></i>
            </div>
          </div>
        </div>
        <ng-template #noPhotos>
          <div class="text-center text-muted py-3">
            <i class="fas fa-image fs-1 mb-2 opacity-50"></i>
            <p class="mb-0">Aucune photo disponible</p>
          </div>
        </ng-template>
      </div>

      <!-- Documents -->
      <div class="documents-section mb-4">
        <h5 class="section-subtitle">
          <i class="fas fa-file-alt me-2"></i>Documents
        </h5>
        <div class="documents-list">
          <a *ngIf="missionSelectionnee.constatAccident" 
             [href]="missionSelectionnee.constatAccident" 
             target="_blank" 
             class="document-item"
             [attr.aria-label]="'Télécharger le constat d\'accident'">
            <i class="fas fa-file-pdf me-2"></i>Constat accident
            <i class="fas fa-download ms-auto"></i>
          </a>
          <a *ngFor="let doc of missionSelectionnee.documentsAssurance; let i = index" 
             [href]="doc" 
             target="_blank" 
             class="document-item"
             [attr.aria-label]="'Télécharger le document d\'assurance ' + (i + 1)">
            <i class="fas fa-file-pdf me-2"></i>Document assurance {{ i + 1 }}
            <i class="fas fa-download ms-auto"></i>
          </a>
          <a *ngIf="missionSelectionnee.cessionCreance" 
             [href]="missionSelectionnee.cessionCreance" 
             target="_blank" 
             class="document-item"
             aria-label="Télécharger la cession de créance">
            <i class="fas fa-file-pdf me-2"></i>Cession de créance
            <i class="fas fa-download ms-auto"></i>
          </a>
          <a *ngIf="missionSelectionnee.ordreReparation" 
             [href]="missionSelectionnee.ordreReparation" 
             target="_blank" 
             class="document-item"
             aria-label="Télécharger l'ordre de réparation">
            <i class="fas fa-file-pdf me-2"></i>Ordre de réparation
            <i class="fas fa-download ms-auto"></i>
          </a>
        </div>
      </div>
      
      <!-- Boutons d'action -->
      <div class="action-buttons mt-auto">
        <button class="btn btn-primary-custom w-100 py-3 fs-5 rounded-pill accept-btn"
                *ngIf="missionSelectionnee && missionSelectionnee.statut === 'en attente'"
                (click)="accepterMission(missionSelectionnee!)"
                [disabled]="processingAction"
                [attr.aria-label]="'Accepter la mission ' + missionSelectionnee.id">
          <i class="fas fa-check-circle me-2"></i>
          <span *ngIf="!processingAction">Accepter la mission</span>
          <span *ngIf="processingAction">
            <i class="fas fa-spinner fa-spin me-2"></i>Traitement...
          </span>
        </button>
        
        <button class="btn btn-danger w-100 py-3 fs-5 rounded-pill mt-3"
                *ngIf="missionSelectionnee && missionSelectionnee.statut === 'en attente'"
                (click)="refuserMission(missionSelectionnee!)"
                [disabled]="processingAction"
                [attr.aria-label]="'Refuser la mission ' + missionSelectionnee.id">
          <i class="fas fa-times-circle me-2"></i>
          <span *ngIf="!processingAction">Refuser la mission</span>
          <span *ngIf="processingAction">
            <i class="fas fa-spinner fa-spin me-2"></i>Traitement...
          </span>
        </button>
        
        <div *ngIf="missionSelectionnee && missionSelectionnee.statut !== 'en attente' && !missionEstVisible(missionSelectionnee)" 
             class="alert alert-info mt-4 text-center border-0 shadow-sm">
          <i class="fas fa-info-circle me-2"></i>
          Cette mission a déjà été 
          <strong>{{ missionSelectionnee.statut === 'en cours' ? 'en cours' : 
                    missionSelectionnee.statut === 'terminée' ? 'terminée' : 'traitée' }}</strong>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Overlay pour le panneau latéral -->
  <div class="side-panel-overlay" [class.active]="panelOuvert" (click)="fermerPanel()"></div>
</div>