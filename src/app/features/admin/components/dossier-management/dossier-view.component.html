<div class="view-overlay" *ngIf="!loading" (click)="close()">
  <div class="view-modal" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>
        <i class="fas fa-folder-open me-2"></i>
        Détail du dossier
      </h2>

      <button class="close-button" (click)="close()" aria-label="Fermer">
        <i class="fas fa-times"></i>
      </button>
    </div>

    


    <div class="dialog-content">

      <!-- Section moderne pour l'état d'avancement du traitement -->
      <div class="statut-avancement-section-admin">
        <h4>
          <i class="fas fa-tasks me-2"></i>
          État d'avancement du traitement
        </h4>
        <div class="statut-avancement-display-admin">
          <span class="badge-statut-admin" [ngClass]="getStatutAvancementClass(mission?.sinistre?.statut)">
            {{ getStatutAvancementLabel(mission?.sinistre?.statut) }}
          </span>
        </div>
      </div>

      <!-- Informations principales du dossier (toujours visible, tout en haut) -->
      <div class="form-section main-info-section">
        <h3><i class="fas fa-info-circle me-2"></i>Informations principales</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Nom</label>
            <div class="readonly-field">{{ assureInfo?.name }} {{ assureInfo?.prenom }}</div>
          </div>
          <div class="form-group">
            <label>Immatriculation</label>
            <div class="readonly-field">{{ getVehiculeInfo(dossier).immatriculation }}</div>
          </div>
          <div class="form-group">
            <label>Voiture</label>
            <div class="readonly-field">{{ getVehiculeInfo(dossier).marque + ' ' + getVehiculeInfo(dossier).modele }}</div>
          </div>
          <div class="form-group">
            <label>Numéro de contact</label>
            <div class="readonly-field">{{ dossier?.contact || dossier?.telephone || assureInfo?.telephone || 'Non spécifié' }}</div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <div class="readonly-field">{{ dossier?.email || assureInfo?.email || 'Non spécifié' }}</div>
          </div>
          <div class="form-group">
            <label>Date du sinistre</label>
            <div class="readonly-field">{{ dossier?.dateSinistre ? (dossier?.dateSinistre | date:'dd/MM/yyyy') : 'Non spécifiée' }}</div>
          </div>
          <div class="form-group">
            <label>Type de sinistre</label>
            <div class="readonly-field">{{ dossier?.type || mission?.sinistre?.type || 'Non spécifié' }}</div>
          </div>
          <div class="form-group">
            <label>Lieu</label>
            <div class="readonly-field">{{ dossier?.lieuSinistre || 'Non spécifié' }}</div>
          </div>
        </div>
      </div>

      <!-- Sections déroulantes -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showClientInfo = !showClientInfo">
          <i class="fas fa-user me-2"></i>Informations du client
          <span class="chevron" [class.open]="showClientInfo">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showClientInfo">
          <!-- Ancien bloc Informations du client -->
      <div class="form-section">
        <div *ngIf="assureInfo" class="form-grid">
          <div class="form-group">
            <label>Nom </label>
            <div class="readonly-field">{{ assureInfo.name }} {{ assureInfo.prenom }}</div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <div class="readonly-field">{{ assureInfo.email }}</div>
          </div>
          <div class="form-group">
            <label>Téléphone</label>
            <div class="readonly-field">{{ assureInfo.telephone }}</div>
          </div>
          <div class="form-group">
            <label>Adresse</label>
            <div class="readonly-field">{{ assureInfo.adresse }}</div>
          </div>
          <div class="form-group">
            <label>Numéro de permis</label>
            <div class="readonly-field">{{ assureInfo.numeroPermis || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Date de création du compte</label>
            <div class="readonly-field">{{ assureInfo.createdAt ? (assureInfo.createdAt | date:'dd/MM/yyyy') : 'Non renseigné' }}</div>
          </div>
        </div>
        <div *ngIf="!assureInfo" class="text-center">
          <p class="text-muted">Aucune information client disponible.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Détails du dossier -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showDossierDetails = !showDossierDetails">
          <i class="fas fa-folder-open me-2"></i>Détails du dossier
          <span class="chevron" [class.open]="showDossierDetails">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showDossierDetails">
          <div class="form-section" >
            <div class="form-grid">
              <div class="form-group">
                <label>ID du sinistre</label>
                <div class="readonly-field">{{ dossier?.id || mission?.sinistre?.id }}</div>
              </div>
              <div class="form-group">
                <label>Type de sinistre</label>
                <div class="readonly-field">{{ dossier?.type || mission?.sinistre?.type }}</div>
              </div>
              <div class="form-group">
                <label>Contact assistance</label>
                  <div class="readonly-field">{{ dossier?.contactAssistance || mission?.sinistre?.contactAssistance }}</div>
              </div>
              <div class="form-group">
                <label>Lien constat</label>
                <div class="readonly-field">{{ dossier?.lienConstat || mission?.sinistre?.lienConstat || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Statut</label>
                <div class="readonly-field">{{ dossier?.statut || mission?.statut }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
        
      <!-- Détails du garage en charge du sinistre -->
      <div class="accordion-section" *ngIf="mission && mission.reparateur">
        <button class="accordion-toggle" (click)="showGarageDetails = !showGarageDetails">
          <i class="fas fa-warehouse me-2"></i>Détails du garage en charge du sinistre
          <span class="chevron" [class.open]="showGarageDetails">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showGarageDetails">
          <div class="form-section">
            <div class="form-grid">
              <div class="form-group">
                <label>Nom du garage</label>
                <div class="readonly-field">{{ mission.reparateur.nomDuGarage || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Email</label>
                <div class="readonly-field">{{ mission.reparateur.email }}</div>
              </div>
              <div class="form-group">
                <label>Téléphone</label>
                <div class="readonly-field">{{ mission.reparateur.telephone }}</div>
              </div>
              <div class="form-group">
                <label>Nom du responsable</label>
                <div class="readonly-field">{{ mission.reparateur.prenom }} {{ mission.reparateur.name }}</div>
              </div>
              <div class="form-group">
                <label>Ville</label>
                <div class="readonly-field">{{ mission.reparateur.ville || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Services proposés</label>
                <div class="readonly-field">
                  <ng-container *ngIf="mission.reparateur.servicePropose?.length; else aucunService">
                    <ul style="margin:0; padding-left: 1.2em;">
                      <li *ngFor="let service of mission.reparateur.servicePropose">{{ service }}</li>
                    </ul>
                  </ng-container>
                  <ng-template #aucunService>Aucun service renseigné</ng-template>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <button class="btn btn-warning" *ngIf="!changerReparateurEnCours" (click)="changerReparateurEnCours = true">
                <i class="fas fa-exchange-alt me-2"></i>Changer de réparateur
              </button>
              <div *ngIf="changerReparateurEnCours">
                <h5><i class="fas fa-exchange-alt me-2"></i>Changer de réparateur</h5>
                <p>Ce dossier est actuellement attribué à un réparateur. Vous pouvez le réassigner à un autre réparateur si nécessaire.</p>
                <div class="form-group">
                  <label>Réparateur actuel :</label>
                  <div class="readonly-field">{{ mission.reparateur.nomDuGarage }} ({{ mission.reparateur.name }} {{ mission.reparateur.prenom }})</div>
                </div>
                <label for="newReparateurSelect">Sélectionner un nouveau réparateur :</label>
                <select id="newReparateurSelect" class="form-select" [(ngModel)]="selectedReparateurId">
                  <option [ngValue]="null">-- Choisir --</option>
                  <option *ngFor="let rep of reparateursValides" [ngValue]="rep.id" [disabled]="rep.id === mission.reparateur.id">
                    {{ rep.nomDuGarage }} ({{ rep.name }} {{ rep.prenom }})
                  </option>
                </select>
                <div class="d-flex justify-content-center gap-2 mt-2">
                  <button class="btn btn-success" (click)="changerReparateur()" [disabled]="!selectedReparateurId">Valider</button>
                  <button class="btn btn-secondary ms-2" (click)="changerReparateurEnCours = false; selectedReparateurId = null">Annuler</button>
                </div>
                <div *ngIf="attributionSuccess" class="alert alert-success mt-2">{{ attributionMessage }}</div>
                <div *ngIf="attributionError" class="alert alert-danger mt-2">{{ attributionMessage }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Véhicule du sinistre -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showVehiculeSinistreInfo = !showVehiculeSinistreInfo">
          <i class="fas fa-car me-2"></i>Véhicule du sinistre
          <span class="chevron" [class.open]="showVehiculeSinistreInfo">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showVehiculeSinistreInfo">
          <div class="form-section">
            <div class="form-grid">
              <div class="form-group">
                <label>Marque</label>
                <div class="readonly-field">{{ getVehiculeInfo(dossier).marque }}</div>
              </div>
              <div class="form-group">
                <label>Modèle</label>
                <div class="readonly-field">{{ getVehiculeInfo(dossier).modele }}</div>
              </div>
              <div class="form-group">
                <label>Immatriculation</label>
                <div class="readonly-field">{{ getVehiculeInfo(dossier).immatriculation }}</div>
              </div>
              <div class="form-group">
                <label>Cylindrée</label>
                <div class="readonly-field">{{ dossier?.vehicule?.cylindree || vehiculeSinistre?.cylindree || getVehiculeAssure()?.cylindree || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Date de mise en circulation</label>
                <div class="readonly-field">{{ dossier?.vehicule?.dateMiseEnCirculation ? (dossier?.vehicule?.dateMiseEnCirculation | date:'dd/MM/yyyy') : vehiculeSinistre?.dateMiseEnCirculation ? (vehiculeSinistre?.dateMiseEnCirculation | date:'dd/MM/yyyy') : getVehiculeAssure()?.dateMiseEnCirculation ? (getVehiculeAssure()?.dateMiseEnCirculation | date:'dd/MM/yyyy') : 'Non renseigné' }}</div>
              </div>
              <div class="form-group" *ngIf="dossier?.vehicule?.carteGrise || vehiculeSinistre?.carteGrise || getVehiculeAssure()?.carteGrise">
                <label>Carte grise</label>
                <div class="readonly-field">{{ dossier?.vehicule?.carteGrise || vehiculeSinistre?.carteGrise || getVehiculeAssure()?.carteGrise }}</div>
              </div>
              <div class="form-group" *ngIf="dossier?.vehicule?.contratAssurance || vehiculeSinistre?.contratAssurance || getVehiculeAssure()?.contratAssurance">
                <label>Contrat d'assurance</label>
                <div class="readonly-field">{{ dossier?.vehicule?.contratAssurance || vehiculeSinistre?.contratAssurance || getVehiculeAssure()?.contratAssurance }}</div>
              </div>
            </div>
            <!-- Images du véhicule -->
            <div *ngIf="(dossier?.vehicule?.imgUrl && dossier?.vehicule?.imgUrl.length > 0) || (getVehiculeAssure()?.imgUrl && getVehiculeAssure()?.imgUrl.length > 0)" class="mt-3">
              <h5><i class="fas fa-images me-2"></i>Images du véhicule ({{ (dossier?.vehicule?.imgUrl?.length || 0) + (getVehiculeAssure()?.imgUrl?.length || 0) }})</h5>
              <div class="vehicle-images-grid">
                <!-- Images depuis dossier.vehicule -->
                <div *ngFor="let imageUrl of dossier?.vehicule?.imgUrl; let i = index" class="vehicle-image-item" (click)="openImageModal(imageUrl, dossier?.vehicule?.imgUrl, i)">
                  <img [src]="imageUrl" [alt]="'Image ' + getVehiculeInfo(dossier).marque + ' ' + getVehiculeInfo(dossier).modele" class="vehicle-image" />
                  <div class="image-overlay">
                    <i class="fas fa-expand-alt"></i>
                  </div>
                </div>
                <!-- Images depuis getVehiculeAssure() -->
                <div *ngFor="let imageUrl of getVehiculeAssure()?.imgUrl; let i = index" class="vehicle-image-item" (click)="openImageModal(imageUrl, getVehiculeAssure()?.imgUrl, i)">
                  <img [src]="imageUrl" [alt]="'Image ' + getVehiculeInfo(dossier).marque + ' ' + getVehiculeInfo(dossier).modele" class="vehicle-image" />
                  <div class="image-overlay">
                    <i class="fas fa-expand-alt"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

            <!-- Photos du véhicule -->
            <div class="accordion-section">
              <button class="accordion-toggle" (click)="showVehiclePhotos = !showVehiclePhotos">
                <i class="fas fa-camera me-2"></i>Photos du l'incident
                <span class="chevron" [class.open]="showVehiclePhotos">&#9660;</span>
              </button>
              <div class="accordion-content" *ngIf="showVehiclePhotos">
            <div class="form-section" *ngIf="isPhotosArrayNonEmpty(mission)">
              <div class="photos-grid">
                <div class="photo-thumbnail" *ngFor="let photo of mission?.photosVehicule">
                  <img [src]="photo" alt="Photo véhicule" class="img-fluid" />
                </div>
              </div>
            </div>
              </div>
            </div>

      <!-- Nomination de l'expert -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showExpertInfo = !showExpertInfo">
          <i class="fas fa-user-tie me-2"></i>Nomination de l'expert
          <span class="chevron" [class.open]="showExpertInfo">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showExpertInfo">
          <div class="form-section">
            <!-- Mode édition -->
            <form *ngIf="editionExpertEnCours; else nominationLectureSeule" (ngSubmit)="enregistrerExpert()">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nom de l'expert</label>
                  <input type="text" class="form-control" [(ngModel)]="expertiseEdit.nomExpert" name="nomExpert">
                </div>
                <div class="form-group">
                  <label>Prénom de l'expert</label>
                  <input type="text" class="form-control" [(ngModel)]="expertiseEdit.prenomExpert" name="prenomExpert">
                </div>
                <div class="form-group">
                  <label>Institution</label>
                  <input type="text" class="form-control" [(ngModel)]="expertiseEdit.institutionExpert" name="institutionExpert">
                </div>
                <div class="form-group">
                  <label>Contact de l'expert</label>
                  <input type="text" class="form-control" [(ngModel)]="expertiseEdit.contactExpert" name="contactExpert">
                </div>
                <div class="form-group">
                  <label>Email de l'expert</label>
                  <input type="email" class="form-control" [(ngModel)]="expertiseEdit.mailExpert" name="emailExpert">
                </div>
                <div class="form-group">
                  <label>Date d'expertise prévue</label>
                  <input type="date" class="form-control" [(ngModel)]="expertiseEdit.dateExpertisePrevue" name="dateExpertisePrevue">
                </div>
              </div>
              <div class="actions-grid">
                <button type="button" class="btn btn-secondary" (click)="annulerExpert()">Annuler</button>
                <button type="submit" class="btn btn-success">Enregistrer</button>
              </div>
            </form>
            <!-- Mode lecture seule pour la nomination -->
            <ng-template #nominationLectureSeule>
              <div class="form-grid">
                <div class="form-group">
                  <label>Nom de l'expert</label>
                  <div class="readonly-field">{{ expertiseCourante?.nomExpert || 'Non renseigné' }}</div>
                </div>
                <div class="form-group">
                  <label>Prénom de l'expert</label>
                  <div class="readonly-field">{{ expertiseCourante?.prenomExpert || 'Non renseigné' }}</div>
                </div>
                <div class="form-group">
                  <label>Contact de l'expert</label>
                  <div class="readonly-field">{{ expertiseCourante?.contactExpert || 'Non renseigné' }}</div>
                </div>
                <div class="form-group">
                  <label>Email de l'expert</label>
                  <div class="readonly-field">{{ expertiseCourante?.mailExpert || 'Non renseigné' }}</div>
                </div>
                <div class="form-group">
                  <label>Institution</label>
                  <div class="readonly-field">{{ expertiseCourante?.institutionExpert || 'Non renseigné' }}</div>
                </div>
                <div class="form-group">
                  <label>Date d'expertise prévue</label>
                  <div class="readonly-field">{{ expertiseCourante?.dateExpertisePrevue || 'Non renseigné' }}</div>
                </div>
              </div>
              <div class="actions-grid">
                <button type="button" class="btn btn-primary" (click)="lancerEditionExpert()">Modifier la nomination</button>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Détails de l'expertise (lecture seule) -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showExpertDetails = !showExpertDetails">
          <i class="fas fa-clipboard-list me-2"></i>Détails de l'expertise
          <span class="chevron" [class.open]="showExpertDetails">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showExpertDetails">
          <div class="form-section">
            <div class="form-grid">
              <div class="form-group">
                <label>Date d'expertise effective</label>
                <div class="readonly-field">{{ expertiseCourante?.dateExpertiseEffective || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Montant chiffrage HT</label>
                <div class="readonly-field">{{ expertiseCourante?.montantChiffrageHT || 'Non renseigné' }} €</div>
              </div>
              <div class="form-group">
                <label>Montant chiffrage TTC</label>
                <div class="readonly-field">{{ expertiseCourante?.montantChiffrageTTC || 'Non renseigné' }} €</div>
              </div>
              <div class="form-group">
                <label>Franchise applicable</label>
                <div class="readonly-field">{{ expertiseCourante?.franchiseApplicable || 'Non renseigné' }} €</div>
              </div>
              <div class="form-group">
                <label>Rapport d'expertise</label>
                <div class="readonly-field">
                  <ng-container *ngIf="expertiseCourante?.rapportExpertise; else pasDeRapport">
                    <a [href]="expertiseCourante.rapportExpertise" target="_blank" rel="noopener" class="btn btn-sm btn-primary me-2">
                      <i class="fas fa-download me-1"></i>Télécharger
                    </a>
                    <a *ngIf="isImageOrPdf(expertiseCourante.rapportExpertise)" [href]="expertiseCourante.rapportExpertise" target="_blank" rel="noopener" class="btn btn-sm btn-info me-2">
                      <i class="fas fa-eye me-1"></i>Voir
                    </a>
                    <span class="text-muted small">{{ getFileNameFromUrl(expertiseCourante.rapportExpertise) }}</span>
                  </ng-container>
                  <ng-template #pasDeRapport>Non renseigné</ng-template>
                </div>
              </div>
              <div class="form-group">
                <label>Observations de l'expert</label>
                <div class="readonly-field">{{ expertiseCourante?.observationsExpert || 'Non renseigné' }}</div>
              </div>
              <div class="form-group">
                <label>Expertise effectuée</label>
                <div class="readonly-field">{{ expertiseCourante?.expertiseEffectuee ? 'Oui' : 'Non' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Données financières du dossier -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showFinancesInfo = !showFinancesInfo">
          <i class="fas fa-euro-sign me-2"></i>Données financières du dossier
          <span class="chevron" [class.open]="showFinancesInfo">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showFinancesInfo">
        <div class="form-section">
          <div class="form-grid">
            <div class="form-group">
              <label>Devis (€)</label>
              <div class="readonly-field">{{ mission?.devis }}</div>
            </div>
            <div class="form-group">
              <label>Facture finale (€)</label>
              <div class="readonly-field">{{ mission?.factureFinale }}</div>
            </div>
            <div class="form-group">
              <label>Statut commission</label>
              <select class="form-select" [(ngModel)]="commissionStatutEdit" [disabled]="savingCommission">
                <option value="payée">Payée</option>
                <option value="non payée">Non payée</option>
              </select>
              <button class="btn btn-primary btn-sm mt-2" (click)="saveCommissionStatut()" [disabled]="savingCommission || isCommissionStatutUnchanged()">
                {{ savingCommission ? 'Sauvegarde...' : 'Sauvegarder' }}
              </button>
              <div *ngIf="commissionSuccess" class="alert alert-success mt-2">Statut de commission mis à jour !</div>
              <div *ngIf="commissionError" class="alert alert-danger mt-2">Erreur lors de la mise à jour.</div>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Informations supplémentaires -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showAdditionalInfo = !showAdditionalInfo">
          <i class="fas fa-info-circle me-2"></i>Informations supplémentaires
          <span class="chevron" [class.open]="showAdditionalInfo">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showAdditionalInfo">
          <div class="form-section">
        <div class="form-grid">
          <div class="form-group">
            <label>Date de création</label>
            <div class="readonly-field">{{ getMissionDate(mission) }}</div>
          </div>
          <div class="form-group">
            <label>Déclarée comme épave</label>
            <div class="readonly-field">{{ mission?.declareCommeEpave ? 'Oui' : 'Non' }}</div>
          </div>
          <div class="form-group">
            <label>Épave validée par admin</label>
            <div class="readonly-field">{{ mission?.epaveValideeParAdmin ? 'Oui' : 'Non' }}</div>
          </div>
        </div>
      </div>
        </div>
      </div>



      <!-- Documents -->
      <div class="accordion-section">
        <button class="accordion-toggle" (click)="showDocuments = !showDocuments">
          <i class="fas fa-file-alt me-2"></i>Documents
          <span class="chevron" [class.open]="showDocuments">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showDocuments">
      <div class="form-section">
        <div class="documents-list">
          <!-- En mode édition, utiliser missionEdit -->
          <ng-container *ngIf="editionEnCours">
            <ng-container *ngIf="missionEdit.documentsAssurance && missionEdit.documentsAssurance.length > 0; else noDocEdit">
              <div *ngFor="let doc of missionEdit.documentsAssurance; let i = index" class="document-item">
                <i class="fas fa-file-pdf me-2"></i>
                {{ getFileNameFromUrl(doc) }}
                <button type="button" class="btn btn-sm btn-primary ms-2" (click)="telechargerDocument(doc)">Télécharger</button>
                <button type="button" class="btn btn-sm btn-danger ms-2" (click)="supprimerDocument(i)">Supprimer</button>
              </div>
            </ng-container>
            <ng-template #noDocEdit>
              <span>Aucun document ajouté.</span>
            </ng-template>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-outline-primary" type="button" (click)="ouvrirModalCreationDocument()">Créer un document</button>
              <button class="btn btn-outline-secondary" type="button" (click)="ouvrirUploadDirect()" [disabled]="uploadingFiles">
                <i class="fas fa-upload me-2"></i>
                {{ uploadingFiles ? 'Upload en cours...' : 'Téléverser des PDF' }}
              </button>
            </div>
          </ng-container>
          
          <!-- En mode lecture seule, utiliser mission -->
          <ng-container *ngIf="!editionEnCours">
            <ng-container *ngIf="mission && mission.documentsAssurance && mission.documentsAssurance.length > 0; else noDocRead">
              <div *ngFor="let doc of mission.documentsAssurance; let i = index" class="document-item">
                <i class="fas fa-file-pdf me-2"></i>
                {{ getFileNameFromUrl(doc) }}
                <button type="button" class="btn btn-sm btn-primary ms-2" (click)="telechargerDocument(doc)">Télécharger</button>
              </div>
            </ng-container>
            <ng-template #noDocRead>
              <span>Aucun document disponible.</span>
            </ng-template>
          </ng-container>
            </div>
          </div>
        </div>
      </div>

      <!-- Attribution du réparateur (pour les dossiers sans mission) -->
      <div class="accordion-section" *ngIf="!mission && dossier">
        <button class="accordion-toggle" (click)="showAttributionSection = !showAttributionSection">
          <i class="fas fa-user-cog me-2"></i>Attribuer ce dossier à un réparateur
          <span class="chevron" [class.open]="showAttributionSection">&#9660;</span>
        </button>
        <div class="accordion-content" *ngIf="showAttributionSection">
          <div class="form-section">
            <h3><i class="fas fa-user-cog me-2"></i>Attribuer ce dossier à un réparateur</h3>
            <p>Ce dossier n'est pas encore traité. Veuillez attribuer un réparateur pour commencer le processus.</p>
            <div *ngIf="!attributionEnCours">
              <button class="btn btn-primary mt-3" (click)="ouvrirAttributionMission()">Attribuer à un réparateur</button>
            </div>
            <div *ngIf="attributionEnCours">
              <label for="reparateurSelect">Sélectionner un réparateur :</label>
              <select id="reparateurSelect" class="form-select" [(ngModel)]="selectedReparateurId">
                <option [ngValue]="null">-- Choisir --</option>
                <option *ngFor="let rep of reparateursValides" [ngValue]="rep.id">{{ rep.nomDuGarage }} ({{ rep.name }} {{ rep.prenom }})</option>
              </select>
              <div class="d-flex justify-content-center gap-2 mt-2">
                <button class="btn btn-success" (click)="creerMissionPourDossier()" [disabled]="!selectedReparateurId">Valider</button>
                <button class="btn btn-secondary ms-2" (click)="attributionEnCours = false">Annuler</button>
              </div>
              <div *ngIf="attributionSuccess" class="alert alert-success mt-2">{{ attributionMessage }}</div>
              <div *ngIf="attributionError" class="alert alert-danger mt-2">{{ attributionMessage }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions pour l'édition -->
      <div class="actions-section mt-4">
        <div class="actions-grid" *ngIf="!editionEnCours">
          <button type="button" class="btn btn-secondary" (click)="close()">Fermer</button>
          <button type="button" class="btn btn-primary" (click)="lancerEdition()">Modifier le dossier</button>
        </div>

        <div class="actions-grid" *ngIf="editionEnCours">
          <button type="button" class="btn btn-secondary" (click)="annulerEdition()">Annuler</button>
          <button type="button" class="btn btn-success" (click)="enregistrerModification()">Enregistrer</button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<div *ngIf="showDocumentModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <app-document-creation-modal
      (documentCreated)="onDocumentCreated($event); fermerModalCreationDocument()"
      (closed)="fermerModalCreationDocument()">
    </app-document-creation-modal>
  </div>
</div>

<!-- Modal pour afficher les images en plein écran -->
<div *ngIf="showImageModal" class="image-modal-overlay" (click)="closeImageModal()">
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5>Images du véhicule</h5>
      <button class="close-btn" (click)="closeImageModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="main-image-container">
        <button *ngIf="currentImageIndex > 0" class="nav-btn prev-btn" (click)="previousImage()">
          <i class="fas fa-chevron-left"></i>
        </button>
        
        <img [src]="currentImageUrl" [alt]="'Image ' + (currentImageIndex + 1)" class="main-image" />
        
        <button *ngIf="currentImageIndex < currentImages.length - 1" class="nav-btn next-btn" (click)="nextImage()">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <div class="image-counter">
        {{ currentImageIndex + 1 }} / {{ currentImages.length }}
      </div>
      
      <div class="thumbnail-container">
        <div *ngFor="let image of currentImages; let i = index" 
             class="thumbnail-item" 
             [class.active]="i === currentImageIndex"
             (click)="selectImage(i)">
          <img [src]="image" [alt]="'Miniature ' + (i + 1)" class="thumbnail-image" />
        </div>
      </div>
    </div>
  </div>
</div>

