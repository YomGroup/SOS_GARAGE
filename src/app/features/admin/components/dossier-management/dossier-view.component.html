<div class="view-overlay" *ngIf="!loading">
  <div class="view-modal">
    <div class="dialog-header">
      <h2>
        <i class="fas fa-folder-open me-2"></i>
        Détail du dossier
      </h2>

      <button class="close-button" (click)="close()" aria-label="Fermer">
        <i class="fas fa-times"></i>
      </button>
    </div>

    


    <div class="dialog-content">

      
      <div class="info-section">
        <h3><i class="fas fa-info-circle me-2"></i>Informations générales</h3>
        <p class="subtitle">Consultez ou modifiez les informations du dossier.</p>
        <div *ngIf="mission">
          <p><strong>ID de la mission :</strong> {{ mission.id }}</p>
          
        </div>
      </div>
      <!-- Affiche le sinistre si aucune mission -->
      <div *ngIf="!mission && edition">
        <div class="form-section">
          <h3><i class="fas fa-user-cog me-2"></i>Attribuer ce dossier à un réparateur</h3>
          <p>Ce dossier n'est pas encore traité. Veuillez attribuer un réparateur pour commencer le processus.</p>
          <div *ngIf="!attributionEnCours">
            <button class="btn btn-primary mt-3" (click)="ouvrirAttributionMission()">Attribuer à un réparateur</button>
          </div>
          <div *ngIf="attributionEnCours">
            <label for="reparateurSelect">Sélectionner un réparateur :</label>
            <select id="reparateurSelect" class="form-select" [(ngModel)]="selectedReparateurId">
              <option [ngValue]="null">-- Choisir --</option>
              <option *ngFor="let rep of reparateursValides" [ngValue]="rep.id">{{ rep.nomDuGarage }} ({{ rep.name }} {{ rep.prenom }})</option>
            </select>
            <div class="d-flex justify-content-center gap-2 mt-2">
              <button class="btn btn-success" (click)="creerMissionPourDossier()" [disabled]="!selectedReparateurId">Valider</button>
              <button class="btn btn-secondary ms-2" (click)="attributionEnCours = false">Annuler</button>
            </div>
            <div *ngIf="attributionSuccess" class="alert alert-success mt-2">{{ attributionMessage }}</div>
            <div *ngIf="attributionError" class="alert alert-danger mt-2">{{ attributionMessage }}</div>
          </div>
        </div>
      </div>
      <!-- Afficher les infos du sinistre même sans mission -->
      <div *ngIf="!mission">
        <div class="form-section">
          <h3><i class="fas fa-car-crash me-2"></i>Détails du sinistre</h3>
          <p><strong>ID du sinistre :</strong> {{ sinistreDuDossier?.id }}</p>
          <div class="form-group">
            <label>Type de sinistre</label>
            <div class="readonly-field">{{ dossier?.type || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Contact assistance</label>
            <div class="readonly-field">{{ sinistreDuDossier?.contactAssistance || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Lien constat</label>
            <div class="readonly-field">{{ sinistreDuDossier?.lienConstat || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Conditions acceptées</label>
            <div class="readonly-field">{{ sinistreDuDossier?.conditionsAcceptees ? 'Oui' : 'Non' }}</div>
          </div>
        </div>
      </div>
      <!-- Détails du dossier (lecture seule uniquement) -->
      <div *ngIf="mission">
        <div class="form-section">
          <h3><i class="fas fa-edit me-2"></i>Détails du dossier</h3>
          <p><strong>ID de la mission :</strong> {{ mission.id }}</p>
          <div class="form-grid">
            <div class="form-group">
              <label>Devis (€)</label>
              <div class="readonly-field">{{ mission?.devis }}</div>
            </div>
            <div class="form-group">
              <label>Facture finale (€)</label>
              <div class="readonly-field">{{ mission?.factureFinale }}</div>
            </div>
            <div class="form-group">
              <label>Prêt de véhicule</label>
              <div class="readonly-field">{{ mission?.pretVehicule ? 'Oui' : 'Non' }}</div>
            </div>
            <div class="form-group">
              <label>Statut</label>
              <div class="readonly-field">{{ mission?.statut }}</div>
            </div>
            <div class="form-group">
              <label>Statut commission</label>
              <select class="form-select" [(ngModel)]="commissionStatutEdit" [disabled]="savingCommission">
                <option value="payée">Payée</option>
                <option value="non payée">Non payée</option>
              </select>
              <button class="btn btn-primary btn-sm mt-2" (click)="saveCommissionStatut()" [disabled]="savingCommission || commissionStatutEdit === mission?.commissionStatut">
                {{ savingCommission ? 'Sauvegarde...' : 'Sauvegarder' }}
              </button>
              <div *ngIf="commissionSuccess" class="alert alert-success mt-2">Statut de commission mis à jour !</div>
              <div *ngIf="commissionError" class="alert alert-danger mt-2">Erreur lors de la mise à jour.</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Détails du sinistre -->
      <div class="form-section" *ngIf="mission?.sinistre">
        <h3><i class="fas fa-car-crash me-2"></i>Détails du sinistre</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Type de sinistre</label>
            <div class="readonly-field">{{ mission?.sinistre?.type }}</div>
          </div>
          <div class="form-group">
            <label>Contact assistance</label>
            <div class="readonly-field">{{ mission?.sinistre?.contactAssistance }}</div>
          </div>
          <div class="form-group">
            <label>Lien constat</label>
            <div class="readonly-field">{{ mission?.sinistre?.lienConstat || 'Non renseigné' }}</div>
          </div>
        </div>
      </div>
      <!-- Détails du véhicule lié -->
      <div class="form-section" *ngIf="mission?.sinistre?.vehicule">
        <h3><i class="fas fa-car me-2"></i>Véhicule lié</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Marque</label>
            <div class="readonly-field">{{ mission?.sinistre?.vehicule?.marque || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Modèle</label>
            <div class="readonly-field">{{ mission?.sinistre?.vehicule?.modele || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Immatriculation</label>
            <div class="readonly-field">{{ mission?.sinistre?.vehicule?.immatriculation || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Cylindrée</label>
            <div class="readonly-field">{{ mission?.sinistre?.vehicule?.cylindree || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Date de mise en circulation</label>
            <div class="readonly-field">{{ mission?.sinistre?.vehicule?.dateMiseEnCirculation || 'Non renseigné' }}</div>
          </div>
        </div>
      </div>
      <!-- Détails du réparateur associé -->
      <div class="form-section" *ngIf="mission?.reparateur">
        <h3><i class="fas fa-user-cog me-2"></i>Réparateur associé</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Nom du garage</label>
            <div class="readonly-field">{{ mission?.reparateur?.nomDuGarage || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <div class="readonly-field">{{ mission?.reparateur?.email }}</div>
          </div>
          <div class="form-group">
            <label>Téléphone</label>
            <div class="readonly-field">{{ mission?.reparateur?.telephone }}</div>
          </div>
          <div class="form-group">
            <label>Nom du responsable</label>
            <div class="readonly-field">{{ mission?.reparateur?.prenom }} {{ mission?.reparateur?.name }}</div>
          </div>
          <div class="form-group">
            <label>Ville</label>
            <div class="readonly-field">{{ mission?.reparateur?.Ville || 'Non renseigné' }}</div>
          </div>
          <div class="form-group">
            <label>Services proposés</label>
            <div class="readonly-field">
              <ng-container *ngIf="mission?.reparateur?.servicePropose?.length; else aucunService">
                <ul style="margin:0; padding-left: 1.2em;">
                  <li *ngFor="let service of mission?.reparateur?.servicePropose">{{ service }}</li>
                </ul>
              </ng-container>
              <ng-template #aucunService>Aucun service renseigné</ng-template>
            </div>
          </div>
        </div>
        <div class="mt-2" *ngIf="edition">
          <button class="btn btn-outline-primary" type="button" (click)="changerReparateurEnCours = !changerReparateurEnCours">Changer de réparateur</button>
        </div>
        <div *ngIf="changerReparateurEnCours && edition" class="mt-3">
          <label for="reparateurSelectChange">Sélectionner un nouveau réparateur :</label>
          <select id="reparateurSelectChange" class="form-select" [(ngModel)]="selectedReparateurId">
            <option [ngValue]="null">-- Choisir --</option>
            <option *ngFor="let rep of reparateursValides" [ngValue]="rep.id">{{ rep.nomDuGarage }} ({{ rep.name }} {{ rep.prenom }})</option>
          </select>
          <div class="d-flex justify-content-center gap-2 mt-2">
            <button class="btn btn-success" (click)="changerReparateur(); changerReparateurEnCours = false" [disabled]="!selectedReparateurId || selectedReparateurId === mission?.reparateur?.id">Valider le changement</button>
            <button class="btn btn-secondary ms-2" (click)="changerReparateurEnCours = false">Annuler</button>
          </div>
          <div *ngIf="attributionSuccess" class="alert alert-success mt-2">{{ attributionMessage }}</div>
          <div *ngIf="attributionError" class="alert alert-danger mt-2">{{ attributionMessage }}</div>
        </div>
      </div>
      <!-- Informations supplémentaires -->
      <div class="form-section" *ngIf="mission">
        <h3><i class="fas fa-info-circle me-2"></i>Informations supplémentaires</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Date de création</label>
            <div class="readonly-field">{{ getMissionDate(mission) }}</div>
          </div>
          <div class="form-group">
            <label>Déclarée comme épave</label>
            <div class="readonly-field">{{ mission?.declareCommeEpave ? 'Oui' : 'Non' }}</div>
          </div>
          <div class="form-group">
            <label>Épave validée par admin</label>
            <div class="readonly-field">{{ mission?.epaveValideeParAdmin ? 'Oui' : 'Non' }}</div>
          </div>
        </div>
      </div>
      <!-- Photos du véhicule -->
      <div class="form-section" *ngIf="isPhotosArrayNonEmpty(mission)">
        <h3><i class="fas fa-camera me-2"></i>Photos du véhicule</h3>
        <div class="photos-grid">
          <div class="photo-thumbnail" *ngFor="let photo of mission?.photosVehicule">
            <img [src]="photo" alt="Photo véhicule" class="img-fluid" />
          </div>
        </div>
      </div>
      <!-- Documents -->
      <div class="form-section">
        <h3><i class="fas fa-file-alt me-2"></i>Documents</h3>
        <div class="documents-list">
          <ng-container *ngIf="missionEdit.documentsAssurance && missionEdit.documentsAssurance.length > 0; else noDoc">
            <div *ngFor="let doc of missionEdit.documentsAssurance; let i = index" class="document-item">
              <i class="fas fa-file-pdf me-2"></i>
              {{ doc.name }}
              <button type="button" class="btn btn-sm btn-primary ms-2" (click)="telechargerDocument(doc)">Télécharger</button>
              <button type="button" class="btn btn-sm btn-danger ms-2" (click)="supprimerDocument(i)" *ngIf="edition">Supprimer</button>
            </div>
          </ng-container>
          <ng-template #noDoc>
            <span>Aucun document ajouté.</span>
          </ng-template>
          <div class="mt-2 d-flex gap-2" *ngIf="edition">
            <button class="btn btn-outline-primary" type="button" (click)="ouvrirModalCreationDocument()">Créer un document</button>
            <button class="btn btn-outline-secondary" type="button" (click)="ouvrirUploadDirect()">Téléverser un PDF</button>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<div *ngIf="showDocumentModal" class="custom-modal-overlay">
  <div class="custom-modal-content">
    <app-document-creation-modal
      (documentCreated)="onDocumentCreated($event); fermerModalCreationDocument()"
      (closed)="fermerModalCreationDocument()">
    </app-document-creation-modal>
  </div>
</div>

 