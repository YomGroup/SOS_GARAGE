<!-- Gestion des Dossiers -->
<div class="content-section" id="dossiers">
  <div class="container-fluid">
    <!-- Titre dynamique selon le filtre -->
    <div class="mb-4">
      <h2 class="section-title">
        <i class="fas fa-folder me-2"></i>
        {{ getTitreFiltre() }}
      </h2>
      <p class="text-muted">{{ getDescriptionFiltre() }}</p>
    </div>

    <!-- Statistiques dossiers -->
    <div class="row mb-4">
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="stats-title opacity-90">Total dossiers</h3>
              <div class="stats-number">{{ totalDossiers }}</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-folder"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="stats-title opacity-90">Non traités</h3>
              <div class="stats-number">{{ nbDossiersNonTraites }}</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-hourglass-start"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="stats-title opacity-90">Traités</h3>
              <div class="stats-number">{{ dossiersTraites }}</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="stats-title opacity-90">Commission payée</h3>
              <div class="stats-number">{{ dossiersCommissionPayee }}</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-euro-sign"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-3">
            <select class="form-select">
              <option value="">Tous les statuts</option>
              <option value="en_cours">En cours</option>
              <option value="termine">Terminé</option>
              <option value="en_attente">En attente</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select">
              <option value="">Tous les clients</option>
              <option value="1">Jean Dupont</option>
              <option value="2">Marie Martin</option>
              <option value="3">Pierre Durand</option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-search"></i
              ></span>
              <input
                type="text"
                class="form-control"
                placeholder="Rechercher un dossier..."
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Boutons de vue -->
    <div class="view-toggle mb-4" *ngIf="!isMobile">
      <button
        class="btn btn-outline-custom"
        [class.active]="isCardView"
        (click)="setCardView(true)"
      >
        <i class="fas fa-th-large me-2"></i>Vue cartes
      </button>
      <button
        class="btn btn-outline-custom"
        [class.active]="!isCardView"
        (click)="setCardView(false)"
      >
        <i class="fas fa-table me-2"></i>Vue tableau
      </button>
    </div>

    <!-- Affichage des dossiers filtrés -->
    <div *ngIf="dossiersFiltres.length; else aucunDossier">
      <div class="card-flex-container" id="cardViewContainer" *ngIf="isCardView">
        <div class="dossier-card-modern" *ngFor="let dossier of dossiersFiltres" style="cursor: pointer">
          <!-- En-tête avec dégradé -->
          <div class="dossier-header">
            <div class="dossier-header-content">
              <div class="dossier-brand">
                <h5 class="dossier-marque">
                  <span *ngIf="isVehiculeLoading(dossier.id)" class="loading-indicator">
                    <i class="fas fa-spinner fa-spin me-1"></i>Chargement...
                  </span>
                  <span *ngIf="!isVehiculeLoading(dossier.id)">{{ getVehiculeInfo(dossier).marque }}</span>
                </h5>
                <div class="dossier-transmission">
                  <span *ngIf="isVehiculeLoading(dossier.id)" class="loading-indicator">
                    <i class="fas fa-spinner fa-spin me-1"></i>Chargement...
                  </span>
                  <span *ngIf="!isVehiculeLoading(dossier.id)">{{ getVehiculeInfo(dossier).modele }}</span>
                </div>
                <div class="dossier-annee">
                  <span *ngIf="isVehiculeLoading(dossier.id)" class="loading-indicator">
                    <i class="fas fa-spinner fa-spin me-1"></i>Chargement...
                  </span>
                  <span *ngIf="!isVehiculeLoading(dossier.id)">{{ getVehiculeInfo(dossier).annee }}</span>
                </div>
              </div>
              <div class="dossier-numero-badge">
                <span class="numero-text">N {{ dossier.numero }}</span>
              </div>
            </div>
            <div class="dossier-statut-badge">
              <span class="statut-text" [ngClass]="getStatutClass(getStatutAffichage(dossier))">{{ getStatutAffichage(dossier) }}</span>
            </div>
          </div>

          <!-- Corps de la carte -->
          <div class="dossier-body">
            <div class="dossier-info-row">
              <div class="info-item">
                <span class="info-label">Type :</span>
                <span class="info-value">{{ dossier.type || 'Roulant' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Assurance :</span>
                <span class="info-value">
                  <span *ngIf="isVehiculeLoading(dossier.id)" class="loading-indicator">
                    <i class="fas fa-spinner fa-spin me-1"></i>Chargement...
                  </span>
                  <span *ngIf="!isVehiculeLoading(dossier.id)">{{ getVehiculeInfo(dossier).assurance }}</span>
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="dossier-actions">
              <button class="btn-action btn-voir" title="Voir" (click)="$event.stopPropagation(); ouvrirDossierView(dossier, false)"><span class="btn-text">Voir</span></button>
              <button class="btn-action btn-modifier" title="Modifier" (click)="$event.stopPropagation(); ouvrirDossierView(dossier, true)"><span class="btn-text">Modifier</span></button>
              <button class="btn-action btn-supprimer" title="Supprimer" (click)="$event.stopPropagation(); supprimerDossier(dossier)"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
      <div
        class="table-responsive"
        *ngIf="!isMobile && !isCardView && dossiersFiltres.length"
        id="tableViewContainer"
      >
        <table class="table table-hover">
          <thead>
            <tr>
              <th>N° Dossier</th>
              <th>Type</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="dossiersFiltres.length; else noDossierTable">
              <tr *ngFor="let dossier of dossiersFiltres">
                <td>#{{ dossier.numero || 'N/A' }}</td>
                <td>{{ dossier.type || 'Non spécifié' }}</td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="getStatutClass(getStatutAffichage(dossier))"
                    >{{ getStatutAffichage(dossier) }}</span
                  >
                </td>
                <td>{{ formatDate(dossier.dateCreation) }}</td>
                <td>
                  <button
                    class="btn btn-sm btn-outline-primary"
                    title="Voir"
                    (click)="ouvrirDossierView(dossier, false)"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    title="Modifier"
                    (click)="ouvrirDossierView(dossier, true)"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    title="Supprimer"
                    (click)="supprimerDossier(dossier)"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </ng-container>
            <ng-template #noDossierTable>
              <tr>
                <td colspan="5" class="text-center text-muted">
                  {{ getMessageAucunDossier() }}
                </td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Message aucun dossier pour la vue carte -->
    <!-- SUPPRIMÉ: <div *ngIf="isCardView && !dossiersFiltres.length" class="alert alert-info">{{ getMessageAucunDossier() }}</div> -->
    
    <!-- Message aucun dossier pour la vue tableau mobile -->
    <!-- SUPPRIMÉ: <div *ngIf="isMobile && !isCardView && !dossiersFiltres.length" class="alert alert-info">{{ getMessageAucunDossier() }}</div> -->
    
    <ng-template #aucunDossier>
      <div class="alert alert-info">
        {{ getMessageAucunDossier() }}
      </div>
    </ng-template>

    <!-- Pagination -->
    <nav aria-label="Navigation des dossiers">
      <ul class="pagination justify-content-center">
        <li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1">Précédent</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#">Suivant</a>
        </li>
      </ul>
    </nav>
  </div>
</div>



<!-- Modale dossier-view -->
<app-dossier-view
  *ngIf="dossierSelectionne || dossierAffichageSelectionne"
  [mission]="dossierSelectionne"
  [dossier]="dossierAffichageSelectionne"
  [sinistre]="dossierSelectionne?.sinistre"
  [loading]="false"
  [edition]="dossierEnEdition"
  (closed)="fermerDossierView()"
  (missionUpdated)="onMissionUpdated($event)"
>
</app-dossier-view>

<router-outlet></router-outlet>
